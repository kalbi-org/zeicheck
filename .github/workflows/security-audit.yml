name: Security Audit

on:
  schedule:
    # æ¯é€±æ—¥æ›œ 00:00 UTCï¼ˆæœˆæ›œ 09:00 JSTï¼‰
    - cron: "0 0 * * 0"
  workflow_dispatch:

permissions:
  issues: write

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      # -------------------------------------------------------
      # a. npm audit â€” è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
      # -------------------------------------------------------
      - name: npm audit
        id: npm_audit
        run: |
          echo "## npm audit" > audit-report.txt
          if npm audit --audit-level=moderate >> audit-report.txt 2>&1; then
            echo "result=pass" >> "$GITHUB_OUTPUT"
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
          fi

      # -------------------------------------------------------
      # b. license-checker â€” ãƒ©ã‚¤ã‚»ãƒ³ã‚¹äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
      # -------------------------------------------------------
      - name: License check
        id: license_check
        run: |
          echo "## License Check" > license-report.txt
          npx license-checker --production --json > license-full.json 2>&1 || true

          # MIT ä»¥å¤–ã®å•é¡Œã®ã‚ã‚‹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’æ¤œå‡º
          VIOLATIONS=$(node -e "
            const data = require('./license-full.json');
            const allowed = ['MIT', 'ISC', 'BSD-2-Clause', 'BSD-3-Clause', 'Apache-2.0', '0BSD', 'BlueOak-1.0.0', 'Unlicense', 'CC0-1.0', 'CC-BY-3.0', 'CC-BY-4.0', 'Python-2.0'];
            const violations = [];
            for (const [pkg, info] of Object.entries(data)) {
              const licenses = String(info.licenses || '');
              const parts = licenses.split(/[;,()]/).map(s => s.trim()).filter(Boolean);
              const ok = parts.some(p => allowed.includes(p));
              if (!ok) violations.push(pkg + ' (' + licenses + ')');
            }
            if (violations.length > 0) {
              console.log('ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«äº’æ›æ€§ã®å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:');
              violations.forEach(v => console.log('- ' + v));
            } else {
              console.log('å…¨ã¦ã® production ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¨±å¯ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã«æº–æ‹ ã—ã¦ã„ã¾ã™ã€‚');
            }
            process.exit(violations.length > 0 ? 1 : 0);
          " 2>&1) || true

          echo "$VIOLATIONS" >> license-report.txt

          if echo "$VIOLATIONS" | grep -q "äº’æ›æ€§ã®å•é¡Œ"; then
            echo "result=fail" >> "$GITHUB_OUTPUT"
          else
            echo "result=pass" >> "$GITHUB_OUTPUT"
          fi

      # -------------------------------------------------------
      # c. typecheck â€” å‹ãƒã‚§ãƒƒã‚¯æ•´åˆæ€§
      # -------------------------------------------------------
      - name: Type check
        id: typecheck
        run: |
          echo "## Type Check" > typecheck-report.txt
          if npm run typecheck >> typecheck-report.txt 2>&1; then
            echo "result=pass" >> "$GITHUB_OUTPUT"
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
          fi

      # -------------------------------------------------------
      # d. build & test â€” ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      # -------------------------------------------------------
      - name: Build and test
        id: build_test
        run: |
          echo "## Build & Test" > build-test-report.txt
          BUILD_OK=true
          TEST_OK=true

          echo "### Build" >> build-test-report.txt
          if ! npm run build >> build-test-report.txt 2>&1; then
            BUILD_OK=false
          fi

          echo "" >> build-test-report.txt
          echo "### Test" >> build-test-report.txt
          if ! npm test >> build-test-report.txt 2>&1; then
            TEST_OK=false
          fi

          if [ "$BUILD_OK" = true ] && [ "$TEST_OK" = true ]; then
            echo "result=pass" >> "$GITHUB_OUTPUT"
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
          fi

      # -------------------------------------------------------
      # GitHub Issue ä½œæˆ
      # -------------------------------------------------------
      - name: Create audit issue
        if: always()
        uses: actions/github-script@v8
        env:
          NPM_AUDIT_RESULT: ${{ steps.npm_audit.outputs.result }}
          LICENSE_RESULT: ${{ steps.license_check.outputs.result }}
          TYPECHECK_RESULT: ${{ steps.typecheck.outputs.result }}
          BUILD_TEST_RESULT: ${{ steps.build_test.outputs.result }}
        with:
          script: |
            const fs = require('fs');

            const icon = (r) => r === 'pass' ? 'âœ…' : 'âŒ';
            const npmAudit = process.env.NPM_AUDIT_RESULT || 'unknown';
            const license = process.env.LICENSE_RESULT || 'unknown';
            const typecheck = process.env.TYPECHECK_RESULT || 'unknown';
            const buildTest = process.env.BUILD_TEST_RESULT || 'unknown';

            const allPass = [npmAudit, license, typecheck, buildTest].every(r => r === 'pass');
            const overallIcon = allPass ? 'âœ…' : 'ğŸš¨';

            const readFile = (path) => {
              try { return fs.readFileSync(path, 'utf8'); } catch { return 'ï¼ˆãƒ¬ãƒãƒ¼ãƒˆãªã—ï¼‰'; }
            };

            const auditReport = readFile('audit-report.txt');
            const licenseReport = readFile('license-report.txt');
            const typecheckReport = readFile('typecheck-report.txt');
            const buildTestReport = readFile('build-test-report.txt');

            const now = new Date();
            const jst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
            const dateStr = jst.toISOString().split('T')[0];

            const title = `${overallIcon} ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ â€” ${dateStr}`;

            const body = `# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

            **å®Ÿè¡Œæ—¥æ™‚**: ${jst.toISOString().replace('T', ' ').substring(0, 19)} JST
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [å®Ÿè¡Œãƒ­ã‚°](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})

            ## ã‚µãƒãƒªãƒ¼

            | ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |
            |---|---|
            | è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (npm audit) | ${icon(npmAudit)} ${npmAudit} |
            | ãƒ©ã‚¤ã‚»ãƒ³ã‚¹äº’æ›æ€§ | ${icon(license)} ${license} |
            | å‹ãƒã‚§ãƒƒã‚¯ | ${icon(typecheck)} ${typecheck} |
            | ãƒ“ãƒ«ãƒ‰ & ãƒ†ã‚¹ãƒˆ | ${icon(buildTest)} ${buildTest} |

            ---

            ## è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ

            ### è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (npm audit)

            \`\`\`
            ${auditReport}
            \`\`\`

            ### ãƒ©ã‚¤ã‚»ãƒ³ã‚¹äº’æ›æ€§

            \`\`\`
            ${licenseReport}
            \`\`\`

            ### å‹ãƒã‚§ãƒƒã‚¯

            \`\`\`
            ${typecheckReport}
            \`\`\`

            ### ãƒ“ãƒ«ãƒ‰ & ãƒ†ã‚¹ãƒˆ

            \`\`\`
            ${buildTestReport}
            \`\`\`
            `.replace(/^            /gm, '');

            // ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
            for (const label of ['audit', 'security']) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                });
              } catch {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                  color: label === 'security' ? 'e11d48' : '6366f1',
                  description: label === 'security' ? 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£' : 'è‡ªå‹•ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ',
                });
              }
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['audit', 'security'],
            });
